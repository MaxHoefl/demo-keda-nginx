# Demo Keda integration with K8s nginx controller

Following tutorial https://blog.cloudacode.com/how-to-autoscale-kubernetes-pods-based-on-ingress-request-prometheus-keda-and-k6-84ae4250a9f3

## Github secrets needed by CICD

- `AZURE_CREDENTIALS`: Generated by `az ad sp create-for-rbac --name "demo" --role contributor --scopes /subscriptions/<subscription id>/resourceGroups/<resource-group> --json-auth`
- `ACR_PASSWORD`: Found in portal -> acr -> keys -> password
- `ACR_USERNAME`: Found in portal -> acr -> keys -> username
- `ACR_REGISTRY_URL`: Found in portal -> acr
- `AKS_CLUSTER_NAME`: AKS cluster name
- `AKS_RG`: Resource group for aks
## Setup
- Create AKS cluster via `terraform init`, `terraform plan`, `terraform apply`
  - The `terraform` script expects arguments for the service principal client id and secret
- Create nginx ingress controller: https://kubernetes.github.io/ingress-nginx/deploy/#quick-start
```
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace
```
- Upgrade nginx helm release to enable metrics to be scraped by Prometheus
```
helm upgrade ingress-nginx ingress-nginx \
--repo https://kubernetes.github.io/ingress-nginx \
--namespace ingress-nginx \
--set controller.metrics.enabled=true \
--set-string controller.podAnnotations."prometheus\.io/scrape"="true" \
--set-string controller.podAnnotations."prometheus\.io/port"="10254"
```
- IMPORTANT: In order for your traffic to reach the external ip of the load balancer created by the nginx controller,
you need to set `externalTrafficPolicy: Local` in the nginx controller service.
- IMPORTANT: Setup the DNS in `/etc/hosts`
```
# /etc/hosts

<LOADBALANCER EXTERNAL IP> demo-api.msy.apps.de
```
- Deploy KEDA
```
kubectl create ns keda

helm repo add kedacore https://kedacore.github.io/charts
helm repo update
helm upgrade --install keda kedacore/keda -n keda
```
- Install prometheus:
```
kubectl create namespace prometheus

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts --namespace prometheus
helm repo update
helm upgrade --install prometheus prometheus-community/prometheus -n prometheus
```
- You can access prometheus at http://localhost:9090 when you port-forward `kubectl --namespace prometheus port-forward prometheus-server-<pod-id> 9090`
- Make sure that prometheus scrapes metrics from nginx-ingress. Send in a couple of requests to `http://demo-api.msy.apps.de/api/health` and query `nginx_ingress_controller_requests` in prometheus. You should see your requests being picked up. 
- Run `k6 run k6test.js` and observe the `demo-api` being eventually scaled to 3 replicas
