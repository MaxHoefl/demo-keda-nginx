# Demo Keda integration with K8s nginx controller

Following tutorial https://blog.cloudacode.com/how-to-autoscale-kubernetes-pods-based-on-ingress-request-prometheus-keda-and-k6-84ae4250a9f3

## Github secrets needed by CICD

- `AZURE_CREDENTIALS`: Generated by `az ad sp create-for-rbac --name "demo" --role contributor --scopes /subscriptions/<subscription id>/resourceGroups/<resource-group> --json-auth`

## Setup

- Create AKS cluster via `terraform init`, `terraform plan`, `terraform apply`
  - The `terraform` script expects arguments for the service principal client id and secret
- Create nginx ingress controller: https://kubernetes.github.io/ingress-nginx/deploy/#quick-start
```
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace
```
- Upgrade nginx helm release to enable metrics to be scraped by Prometheus
```
helm upgrade ingress-nginx ingress-nginx \
--repo https://kubernetes.github.io/ingress-nginx \
--namespace ingress-nginx \
--set controller.metrics.enabled=true \
--set-string controller.podAnnotations."prometheus\.io/scrape"="true" \
--set-string controller.podAnnotations."prometheus\.io/port"="10254"
```
- Deploy KEDA
```
kubectl create ns keda

helm repo add kedacore https://kedacore.github.io/charts
helm repo update
helm upgrade --install keda kedacore/keda -n keda
```
- Setup github repository secrets:
  - `ACR_PASSWORD`: Found in portal -> acr -> keys -> password
  - `ACR_USERNAME`: Found in portal -> acr -> keys -> username
  - `ACR_REGISTRY_URL`: Found in portal -> acr
  - `AKS_CLUSTER_NAME`: AKS cluster name
  - `AKS_RG`: Resource group for aks
